name: Build NAT64 Appliance Image

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag (e.g., v1.0.0)'
        required: true
      ci_framework_repo:
        description: 'ci-framework repository (for testing forks)'
        required: false
        default: 'https://github.com/openstack-k8s-operators/ci-framework.git'
      ci_framework_ref:
        description: 'ci-framework branch/tag/PR (e.g., main, my-branch, refs/pull/123/head)'
        required: false
        default: 'main'

  # Run weekly on Mondays at 00:00 UTC
  schedule:
    - cron: '0 0 * * 1'

jobs:
  build-image:
    runs-on: ubuntu-22.04

    # Permission needed to create a release and upload assets
    permissions:
      contents: write

    env:
      WORK_DIR: ${{ github.workspace }}/ci-framework-data

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Clone ci-framework Repository
        run: |
          CI_REPO="${{ inputs.ci_framework_repo || 'https://github.com/openstack-k8s-operators/ci-framework.git' }}"
          CI_REF="${{ inputs.ci_framework_ref || 'main' }}"
          
          echo "Cloning ci-framework..."
          echo "  Repository: $CI_REPO"
          echo "  Reference: $CI_REF"
          
          # Check if this is a special ref (like refs/pull/123/head)
          if [[ "$CI_REF" == refs/* ]]; then
            echo "Detected special ref, using fetch method..."
            git clone "$CI_REPO" ${{ github.workspace }}/ci-framework
            cd ${{ github.workspace }}/ci-framework
            git fetch origin "$CI_REF"
            git checkout FETCH_HEAD
          else
            echo "Detected branch/tag, using direct clone with shallow history..."
            git clone --depth 1 --branch "$CI_REF" "$CI_REPO" \
              ${{ github.workspace }}/ci-framework
          fi
          
          echo "ci-framework cloned successfully"
          cd ${{ github.workspace }}/ci-framework
          echo "Current commit: $(git rev-parse HEAD)"
          echo "Current branch/ref: $(git describe --all)"

      - name: 3. Install System Dependencies
        run: |
          echo "Installing system dependencies for diskimage-builder..."
          sudo apt-get update
          sudo apt-get install -y \
            python3-pip \
            python3-venv \
            qemu-utils \
            dosfstools \
            xfsprogs \
            kpartx \
            debootstrap \
            gdisk \
            git
          echo "System dependencies installed"

      - name: 4. Setup Python Virtual Environment
        run: |
          echo "Creating Python virtual environment at ~/nat64_venv..."
          python3 -m venv ~/nat64_venv
          source ~/nat64_venv/bin/activate
          
          pip install --upgrade pip setuptools wheel
          
          echo "Installing Ansible and diskimage-builder..."
          pip install ansible-core
          pip install diskimage-builder
          
          echo "Environment setup complete"


      - name: 5. Create Ansible Playbook for Building NAT64 Image
        run: |
          cat > ${{ github.workspace }}/build-nat64.yml << 'EOF'
          ---
          - name: Build nat64-appliance image
            hosts: localhost
            connection: local
            gather_facts: true
            vars:
              cifmw_basedir: "${{ env.WORK_DIR }}"
              cifmw_nat64_appliance_run_dib_as_root: false
              cifmw_nat64_appliance_use_ci_script: false
              cifmw_nat64_appliance_venv_dir: "{{ ansible_env.HOME }}/nat64_venv"
            roles:
              - nat64_appliance
          EOF

          echo "Ansible playbook created"
          cat ${{ github.workspace }}/build-nat64.yml

      - name: 6. Run Ansible Playbook to Build Image
        run: |
          echo "Building NAT64 appliance image using Ansible..."
          echo "Using ci-framework role defaults for DIB configuration"
          echo "Skipping package installation (already done in step 3)"
          
          cd ${{ github.workspace }}/ci-framework
          
          # Activate the venv and run the playbook
          source ~/nat64_venv/bin/activate
          
          # Skip 'packages' tag since we already installed dependencies
          # Use our venv at ~/nat64_venv instead of letting role create one
          ANSIBLE_ROLES_PATH=${{ github.workspace }}/ci-framework/roles \
            ansible-playbook -v \
              --skip-tags packages \
              ${{ github.workspace }}/build-nat64.yml
          
          echo "Image build completed successfully"

      - name: 7. Verify Built Image
        run: |
          IMAGE_PATH="${{ env.WORK_DIR }}/nat64_appliance/nat64-appliance.qcow2"

          if [ -f "$IMAGE_PATH" ]; then
            echo "Built image details:"
            ls -lh "$IMAGE_PATH"
            qemu-img info "$IMAGE_PATH"
          else
            echo "ERROR: Image file not found at $IMAGE_PATH"
            echo "Checking work directory contents:"
            ls -laR "${{ env.WORK_DIR }}"
            exit 1
          fi

      - name: 8. Create Unique Release Tag and Rename Image
        id: release_tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            # Manual run: use provided tag
            RELEASE_TAG="${{ inputs.release_tag }}"
          else
            # Scheduled run: generate timestamp-based tag
            RELEASE_TAG="build-$(date +%Y%m%d-%H%M%S)"
          fi

          echo "release_tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $RELEASE_TAG"

          # Rename image to include the release tag
          TAGGED_IMAGE="nat64-appliance-${RELEASE_TAG}.qcow2"
          mv ${{ env.WORK_DIR }}/nat64_appliance/nat64-appliance.qcow2 \
             ${{ github.workspace }}/${TAGGED_IMAGE}

          echo "tagged_image=$TAGGED_IMAGE" >> $GITHUB_OUTPUT
          echo "Image renamed to: $TAGGED_IMAGE"
          ls -lh ${{ github.workspace }}/${TAGGED_IMAGE}

      - name: 9. Create Versioned GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_tag.outputs.release_tag }}
          name: "NAT64 Appliance ${{ steps.release_tag.outputs.release_tag }}"
          body: |
            NAT64 Appliance image built by GitHub Actions.

            ## Build Configuration

            - **ci-framework repository**: `${{ inputs.ci_framework_repo || 'https://github.com/openstack-k8s-operators/ci-framework.git' }}`
            - **ci-framework reference**: `${{ inputs.ci_framework_ref || 'main' }}`
            - **Build type**: ${{ github.event_name == 'schedule' && 'Scheduled (weekly)' || 'Manual dispatch' }}

            DIB configuration uses defaults from the ci-framework nat64_appliance role.

            ## Usage

            For usage instructions and deployment examples, see the
            [nat64_appliance README](https://github.com/openstack-k8s-operators/ci-framework/blob/main/roles/nat64_appliance/README.md).
          files: ${{ steps.release_tag.outputs.tagged_image }}

      - name: 10. Update 'latest' Release Tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "NAT64 Appliance (Latest)"
          prerelease: true
          body: |
            This is the latest NAT64 Appliance build. This release is automatically updated.

            **Latest Build**: ${{ steps.release_tag.outputs.release_tag }}

            For a specific version or to pin your CI to a known-good build, use one of the versioned releases.

            ## Usage

            For usage instructions and deployment examples, see the
            [nat64_appliance README](https://github.com/openstack-k8s-operators/ci-framework/blob/main/roles/nat64_appliance/README.md).
          files: ${{ steps.release_tag.outputs.tagged_image }}
